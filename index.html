<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>VR Viewer – Jetson Stream</title>
  <style>
    :root{--bg:#0b0f14;--card:#121820;--muted:#7e8a9a;--txt:#e9eef5;--acc:#5eead4}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e141b);color:var(--txt);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:960px;margin:24px auto;padding:16px}
    .card{background:var(--card);border:1px solid #1e2937;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    h1{margin:0 0 6px;font-size:24px}
    h2{margin:16px 0 8px;font-size:18px;color:#cbd5e1}
    p{margin:8px 0;color:var(--muted)}
    label{font-size:12px;color:#9aa6b2}
    input,select,button{border-radius:12px;border:1px solid #2a3748;background:#0e1420;color:var(--txt);padding:10px 12px}
    input,select{width:100%}
    button{cursor:pointer;transition:.15s transform,.15s background}
    button:hover{transform:translateY(-1px)}
    .row{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:720px){.row{grid-template-columns:1.2fr .8fr}}

    /* Viewer */
    .viewer{position:relative;background:#000;border-radius:16px;overflow:hidden;min-height:280px}
    .mono,.left,.right{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000}
    .mono video,.mono img,.left canvas,.right canvas{max-width:100%;max-height:100%;}
    .vr .mono{display:none}
    .vr .left,.vr .right{display:block}
    .left,.right{display:none}
    .left{right:50%;border-right:1px solid #111}
    .right{left:50%}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    .toolbar > *{flex:1}
    .toolbar .group{display:flex;gap:8px}
    .pill{background:#0e1726;border:1px solid #223048;border-radius:999px;padding:6px 10px;color:#b6c2cf;font-size:12px;display:inline-flex;gap:8px;align-items:center}
    .accent{background:linear-gradient(90deg,#0f766e,#0ea5e9);border:0}

    .hint{font-size:12px;color:#94a3b8}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="margin-bottom:16px">
      <h1>VR Viewer – Jetson Stream</h1>
      <p>Abre tu stream de la Jetson y míralo en <strong>pantalla completa</strong> o en modo <strong>Cardboard VR (doble</strong>). Funciona con <span class="pill">MJPEG (HTTP)</span> y con <span class="pill">VIDEO URL (HLS/archivo)</span>. Para WebRTC puedes usar el <em>player</em> del servidor y, si no expone control directo del <code>&lt;video&gt;</code>, usa el modo "Iframe" abajo.</p>
      <div class="row" style="margin-top:12px">
        <div>
          <label>URL del stream (ej: <code>http://JETSON_IP:8080/?action=stream</code> para MJPEG, o <code>https://.../index.m3u8</code>)</label>
          <input id="src" placeholder="pega aquí la URL de tu stream" />
        </div>
        <div>
          <label>Modo de entrada</label>
          <select id="mode">
            <option value="mjpeg">MJPEG (img)</option>
            <option value="video">VIDEO (HLS/MP4)</option>
            <option value="iframe">IFRAME (player externo)</option>
          </select>
        </div>
      </div>
      <div class="toolbar" style="margin-top:12px">
        <button id="btnLoad" class="accent">Cargar stream</button>
        <div class="group">
          <button id="btnVR">Alternar VR (doble)</button>
          <button id="btnFS">Pantalla completa</button>
        </div>
      </div>
      <p class="hint">Consejo: gira el teléfono a horizontal. En VR, ajusta el <em>zoom</em> del navegador si necesitas separar más/menos las imágenes.</p>
    </div>

    <div class="card viewer" id="viewer">
      <div class="mono" id="mono">
        <video id="video" playsinline muted></video>
        <img id="mjpeg" alt="stream" style="display:none"/>
        <iframe id="frame" style="display:none;border:0;width:100%;height:100%" allow="autoplay; fullscreen; xr-spatial-tracking; gyroscope; accelerometer"></iframe>
      </div>
      <div class="left"><canvas id="left"></canvas></div>
      <div class="right"><canvas id="right"></canvas></div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>¿Cómo lo uso?</h2>
      <ol>
        <li>En la Jetson, sirve tu vídeo (ver instrucciones resumidas debajo).</li>
        <li>Conecta el teléfono a la misma red Wi‑Fi.</li>
        <li>Abre esta página desde el teléfono (<code>http://&lt;IP-de-la-Jetson&gt;:8000</code> si la sirves con Python).</li>
        <li>Pega la URL del stream y pulsa <strong>Cargar stream</strong>.</li>
        <li>Pulsa <strong>Pantalla completa</strong> y luego <strong>Alternar VR</strong>. Inserta el teléfono en tus lentes.</li>
      </ol>
      <p class="hint">Con una sola cámara verás vídeo <em>monoscópico</em> (la imagen se duplica a izquierda/derecha para Cardboard). Para vista 3D real, necesitas dos cámaras sincronizadas y dos streams.</p>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Jetson – Opciones de streaming rápidas</h2>
      <p><strong>Opción A – ultra simple (MJPEG)</strong> usando <code>mjpg-streamer</code> (más consumo de ancho de banda, pero inmediato):</p>
      <pre style="white-space:pre-wrap;background:#0b1220;padding:12px;border-radius:12px;overflow:auto">sudo apt install -y mjpg-streamer
# USB cam (ajusta /dev/video0 y resolución)
mjpg_streamer -i "input_uvc.so -d /dev/video0 -r 1280x720 -f 30" \
              -o "output_http.so -w ./www -p 8080"
# Abre: http://JETSON_IP:8080/?action=stream</pre>

      <p><strong>Opción B – baja latencia real (WebRTC)</strong> con <em>MediaMTX</em> y GStreamer (usa HW encoder en Jetson):</p>
      <pre style="white-space:pre-wrap;background:#0b1220;padding:12px;border-radius:12px;overflow:auto"># 1) Levanta MediaMTX (servidor) – lo más fácil es Docker
sudo docker run --rm -it --network host bluenviron/mediamtx:latest

# 2) Publica tu cámara como RTSP y que MediaMTX lo re-despache
# CSI (cámara IMX219/IMX477 en conector):
gst-launch-1.0 nvarguscamerasrc ! 'video/x-raw(memory:NVMM),width=1280,height=720,framerate=30/1' \
  ! nvvideoconvert ! nvv4l2h264enc insert-sps-pps=true iframeinterval=30 control-rate=1 bitrate=4000000 \
  ! h264parse config-interval=1 ! rtspclientsink location=rtsp://127.0.0.1:8554/cam protocols=tcp

# USB (UVC):
gst-launch-1.0 v4l2src device=/dev/video0 ! 'video/x-raw,format=NV12,width=1280,height=720,framerate=30/1' \
  ! nvvidconv ! nvv4l2h264enc insert-sps-pps=true iframeinterval=30 control-rate=1 bitrate=4000000 \
  ! h264parse config-interval=1 ! rtspclientsink location=rtsp://127.0.0.1:8554/cam protocols=tcp

# 3) En el móvil, abre el reproductor WebRTC de MediaMTX y apunta a rtsp://JETSON_IP:8554/cam
# (Busca la página de "WebRTC player" del propio servidor y pega esa URL RTSP)
</pre>
      <p class="hint">Latencias típicas: MJPEG ~250–600 ms; WebRTC ~60–200 ms. Para audiencias o demo pública, prefiere WebRTC.</p>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Servir esta página desde la Jetson</h2>
      <pre style="white-space:pre-wrap;background:#0b1220;padding:12px;border-radius:12px;overflow:auto">python3 -m http.server 8000
# Luego entra desde el teléfono:
#   http://IP_DE_LA_JETSON:8000</pre>
    </div>
  </div>

  <script>
    const modeSel = document.getElementById('mode');
    const urlInp = document.getElementById('src');
    const btnLoad = document.getElementById('btnLoad');
    const btnVR = document.getElementById('btnVR');
    const btnFS = document.getElementById('btnFS');

    const viewer = document.getElementById('viewer');
    const mono = document.getElementById('mono');
    const vid = document.getElementById('video');
    const img = document.getElementById('mjpeg');
    const ifr = document.getElementById('frame');

    const left = document.getElementById('left');
    const right = document.getElementById('right');
    const lctx = left.getContext('2d');
    const rctx = right.getContext('2d');

    let drawTimer = null;

    function stopVRDraw(){ if(drawTimer){ cancelAnimationFrame(drawTimer); drawTimer=null } }

    function startVRDraw(fromEl){
      function draw(){
        const w = viewer.clientWidth;
        const h = viewer.clientHeight;
        left.width = right.width = Math.floor(w/2);
        left.height = right.height = h;
        try{
          if(fromEl.tagName === 'VIDEO'){
            lctx.drawImage(fromEl, 0, 0, left.width, left.height);
            rctx.drawImage(fromEl, 0, 0, right.width, right.height);
          } else if(fromEl.tagName === 'IMG'){
            lctx.drawImage(fromEl, 0, 0, left.width, left.height);
            rctx.drawImage(fromEl, 0, 0, right.width, right.height);
          }
        }catch(e){}
        drawTimer = requestAnimationFrame(draw);
      }
      draw();
    }

    function load(){
      const url = urlInp.value.trim();
      const mode = modeSel.value;
      vid.style.display = 'none';
      img.style.display = 'none';
      ifr.style.display = 'none';

      if(!url){ alert('Pega la URL del stream.'); return }

      if(mode==='mjpeg'){
        img.src = url;
        img.style.display='block';
        vid.pause();
        vid.removeAttribute('src');
        mono.style.display='flex';
      } else if(mode==='video'){
        vid.src = url; // para HLS en Safari/iOS funciona directo; en Android/Chrome usa extensiones/servidor con MSE
        vid.autoplay = true; vid.muted = true; vid.playsInline = true; vid.style.display='block';
        img.src = ''; img.style.display='none';
        mono.style.display='flex';
        vid.play().catch(()=>{});
      } else if(mode==='iframe'){
        ifr.src = url; // por ejemplo, el player WebRTC de tu servidor
        ifr.style.display='block';
        img.style.display='none'; vid.style.display='none';
        mono.style.display='flex';
      }

      if(viewer.classList.contains('vr')){
        toggleVR(true);
      }
    }

    function toggleVR(forceOn){
      const willOn = forceOn ?? !viewer.classList.contains('vr');
      const active = modeSel.value==='mjpeg' ? img : (modeSel.value==='iframe' ? ifr : vid);
      if(willOn){
        viewer.classList.add('vr');
        startVRDraw(active);
      }else{
        viewer.classList.remove('vr');
        stopVRDraw();
      }
    }

    async function goFullscreen(){
      const el = viewer;
      try{
        if(el.requestFullscreen) await el.requestFullscreen();
        else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
      }catch(e){}
    }

    btnLoad.addEventListener('click', load);
    btnVR.addEventListener('click', ()=> toggleVR());
    btnFS.addEventListener('click', goFullscreen);

    // orient a landscape si el usuario lo permite
    if(screen.orientation && screen.orientation.lock){
      try{ screen.orientation.lock('landscape'); }catch(e){}
    }
  </script>
</body>
</html>